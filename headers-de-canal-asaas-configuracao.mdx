---
title: "Headers Asaas - Configura√ß√£o"
---

Este sistema automaticamente adiciona headers customizados a todas as requisi√ß√µes para a API do Asaas, permitindo identificar o canal/parceria de origem das transa√ß√µes.

## Vari√°veis de Ambiente Necess√°rias

Adicione as seguintes vari√°veis no seu arquivo `.env`:

```bash
# Ativar/Desativar headers de canal
ASAAS_ORIGIN_HEADERS_ENABLED=true

# Headers fixos do canal
ASAAS_ORIGIN_HEADER=https://seudominio.com.br
ASAAS_CHANNEL_ACCESS_TOKEN=seu_token_do_canal_asaas

# Refer√™ncia externa padr√£o (opcional)
ASAAS_DEFAULT_EXTERNAL_REFERENCE=default_channel_ref
```

## Headers Enviados Automaticamente

Quando habilitado (`ASAAS_ORIGIN_HEADERS_ENABLED=true`), o sistema envia os seguintes headers em todas as chamadas para a API do Asaas:

- **Origin**: Identificador fixo do canal (valor de `ASAAS_ORIGIN_HEADER`)
- **Origin-Channel-Access-Token**: Token de acesso do canal (valor de `ASAAS_CHANNEL_ACCESS_TOKEN`)
- **Origin-Channel-External-Reference**: Refer√™ncia din√¢mica do tenant/loja atual

### Como funciona a refer√™ncia externa (`Origin-Channel-External-Reference`)

O sistema obt√©m automaticamente a refer√™ncia do tenant/loja atrav√©s da seguinte ordem de prioridade:

1. **Sess√£o web**: Se `session('loja_id')` existir, usa formato `loja_{id}`
2. **Dom√≠nio/Host**: Se for multi-tenant por dom√≠nio, extrai do host (ex: `tenant_minhaloja` para `minhaloja.seudominio.com`)
3. **Fallback**: Usa valor de `ASAAS_DEFAULT_EXTERNAL_REFERENCE` se configurado

## Arquivos Modificados

### Novos Arquivos

- `app/Services/OriginChannelHeaders.php` - Servi√ßo respons√°vel por gerar os headers din√¢micos
- `docs/asaas_origin_headers.md` - Esta documenta√ß√£o

### Arquivos Modificados

- `config/asaas.php` - Adicionadas configura√ß√µes dos headers de origem
- `app/Providers/AppServiceProvider.php` - Registrado o servi√ßo no container
- `vendor/leopaulo88/asaas-sdk-laravel/src/Support/AsaasClient.php` - Modificado `getHeaders()` para incluir headers din√¢micos

## Exemplo de Headers Enviados

Com as configura√ß√µes:

```bash
ASAAS_ORIGIN_HEADERS_ENABLED=true
ASAAS_ORIGIN_HEADER=https://nortgraf.com.br
ASAAS_CHANNEL_ACCESS_TOKEN=ch_abc123
```

E uma sess√£o com `loja_id = 42`, todas as requisi√ß√µes para o Asaas incluir√£o:

```http
Origin: https://nortgraf.com.br
Origin-Channel-Access-Token: ch_abc123
Origin-Channel-External-Reference: loja_42
```

## Desabilita√ß√£o

Para desabilitar os headers customizados, simplesmente configure:

```bash
ASAAS_ORIGIN_HEADERS_ENABLED=false
```

## Logs e Debug

O sistema loga avisos em caso de erros na gera√ß√£o de headers, mas falha silenciosamente para n√£o quebrar o fluxo de pagamentos. Verifique logs com:

```bash
# Pattern: [OriginChannelHeaders] ou [AsaasClient]
tail -f storage/logs/laravel.log | grep -E "OriginChannelHeaders|AsaasClient"
```

## Importante

‚ö†Ô∏è **Modifica√ß√£o do Vendor**: O arquivo `vendor/leopaulo88/asaas-sdk-laravel/src/Support/AsaasClient.php` foi modificado.

**Recomenda√ß√µes**:

- Considere fazer um fork do pacote e usar sua vers√£o
- Ou use patches do Composer (`cweagans/composer-patches`)
- Documente esta modifica√ß√£o para atualiza√ß√µes futuras do pacote

---

## Implementa√ß√£o Detalhada

Esta se√ß√£o documenta todos os passos realizados para implementar o sistema de headers de canal.

### 1. Cria√ß√£o do Servi√ßo Principal

**Arquivo:** `app/Services/OriginChannelHeaders.php`

Servi√ßo respons√°vel por gerar os headers din√¢micos baseado na configura√ß√£o e contexto atual:

```php
<?php

namespace App\Services;

use Illuminate\Support\Facades\Config;

class OriginChannelHeaders
{
    /**
         * Gera headers din√¢micos para integra√ß√£o com canal Asaas
              */
                  public function forCurrentTenant(): array
                      {
                              $headers = [];

                                      // Origin (fixo do canal)
                                              $origin = Config::get('asaas.origin_headers.origin');
                                                      if ($origin) {
                                                                  $headers['Origin'] = $origin;
                                                                          }

                                                                                  // Origin-Channel-Access-Token (fixo do canal)
                                                                                          $channelToken = Config::get('asaas.origin_headers.channel_access_token');
                                                                                                  if ($channelToken) {
                                                                                                              $headers['Origin-Channel-Access-Token'] = $channelToken;
                                                                                                                      }

                                                                                                                              // Origin-Channel-External-Reference (tenant/loja atual)
                                                                                                                                      $externalRef = $this->getCurrentTenantReference();
                                                                                                                                              if ($externalRef) {
                                                                                                                                                          $headers['Origin-Channel-External-Reference'] = $externalRef;
                                                                                                                                                                  }

                                                                                                                                                                          return $headers;
                                                                                                                                                                              }

                                                                                                                                                                                  /**
                                                                                                                                                                                       * Verifica se deve enviar headers de canal
                                                                                                                                                                                            */
                                                                                                                                                                                                public function shouldSendHeaders(): bool
                                                                                                                                                                                                    {
                                                                                                                                                                                                            return Config::get('asaas.origin_headers.enabled', false);
                                                                                                                                                                                                                }

                                                                                                                                                                                                                    /**
                                                                                                                                                                                                                         * Obt√©m refer√™ncia externa do tenant atual
                                                                                                                                                                                                                              */
                                                                                                                                                                                                                                  protected function getCurrentTenantReference(): ?string
                                                                                                                                                                                                                                      {
                                                                                                                                                                                                                                              try {
                                                                                                                                                                                                                                                          // Prioridade 1: Sess√£o web (loja_id)
                                                                                                                                                                                                                                                                      $lojaId = session('loja_id');
                                                                                                                                                                                                                                                                                  if ($lojaId) {
                                                                                                                                                                                                                                                                                                  return "loja_{$lojaId}";
                                                                                                                                                                                                                                                                                                              }

                                                                                                                                                                                                                                                                                                                          // Prioridade 2: Host/dom√≠nio (multi-tenant)
                                                                                                                                                                                                                                                                                                                                      if (app()->bound('request')) {
                                                                                                                                                                                                                                                                                                                                                      $request = app('request');
                                                                                                                                                                                                                                                                                                                                                                      $host = $request->getHost();
                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                      if ($host && !in_array($host, ['localhost', '127.0.0.1', 'nortgraf.com.br', 'www.nortgraf.com.br'])) {
                                                                                                                                                                                                                                                                                                                                                                                                                          $parts = explode('.', $host);
                                                                                                                                                                                                                                                                                                                                                                                                                                              if (count($parts) >= 2) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      return "tenant_{$parts[0]}";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              return "host_{$host}";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      // Prioridade 3: Fallback configurado
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  return Config::get('asaas.origin_headers.default_external_reference');

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          } catch (\Exception $e) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      \Log::warning('[OriginChannelHeaders] Erro ao obter refer√™ncia do tenant', [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      'error' => $e->getMessage()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ]);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              return null;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }
```

### 2. Configura√ß√£o no arquivo `config/asaas.php`

Adicionada nova se√ß√£o de configura√ß√£o:

```php
/*
|--------------------------------------------------------------------------
| Origin Headers (Canal/Parceria)
|--------------------------------------------------------------------------
|
| Headers adicionais enviados nas requisi√ß√µes para identificar o canal
| de origem das transa√ß√µes. Usado em parcerias com o Asaas.
|
*/
'origin_headers' => [
    'enabled' => (bool) env('ASAAS_ORIGIN_HEADERS_ENABLED', false),
        'origin' => env('ASAAS_ORIGIN_HEADER'),
            'channel_access_token' => env('ASAAS_CHANNEL_ACCESS_TOKEN'),
                'default_external_reference' => env('ASAAS_DEFAULT_EXTERNAL_REFERENCE'),
                ],
```

### 3. Registro no Container Laravel

**Arquivo:** `app/Providers/AppServiceProvider.php`

Adicionado no m√©todo `register()`:

```php
// Registra o servi√ßo de headers de canal para integra√ß√£o com Asaas
$this->app->singleton(\App\Services\OriginChannelHeaders::class, function ($app) {
    return new \App\Services\OriginChannelHeaders();
    });
```

### 4. Modifica√ß√£o do SDK Asaas

**Arquivo:** `vendor/leopaulo88/asaas-sdk-laravel/src/Support/AsaasClient.php`

Modificado o m√©todo `getHeaders()`:

```php
/**
 * @return array<string, mixed>
  */
  protected function getHeaders(): array
  {
      $headers = [
              'access_token' => $this->config['api_key'],
                      'Accept' => 'application/json',
                              'Content-Type' => 'application/json',
                                      'User-Agent' => 'Asaas-SDK-Laravel/1.0',
                                          ];

                                              // Headers din√¢micos de canal (para integra√ß√µes/parcerias)
                                                  try {
                                                          if (app()->bound(\App\Services\OriginChannelHeaders::class)) {
                                                                      $channelHeadersService = app(\App\Services\OriginChannelHeaders::class);
                                                                                  if ($channelHeadersService->shouldSendHeaders()) {
                                                                                                  $dynamicHeaders = $channelHeadersService->forCurrentTenant();
                                                                                                                  $headers = array_merge($headers, $dynamicHeaders);
                                                                                                                              }
                                                                                                                                      }
                                                                                                                                          } catch (\Throwable $e) {
                                                                                                                                                  // Falha silenciosa para n√£o quebrar requisi√ß√µes se o servi√ßo falhar
                                                                                                                                                          if (function_exists('logger')) {
                                                                                                                                                                      logger()->warning('[AsaasClient] Erro ao obter headers de canal', [
                                                                                                                                                                                      'error' => $e->getMessage()
                                                                                                                                                                                                  ]);
                                                                                                                                                                                                          }
                                                                                                                                                                                                              }

                                                                                                                                                                                                                  return $headers;
                                                                                                                                                                                                                  }
```

### 5. Arquivo de Exemplo de Configura√ß√£o

**Arquivo:** `.env.asaas.example`

```bash
# =============================================================================
# ASAAS - HEADERS DE CANAL/PARCERIA
# =============================================================================

# Ativar headers customizados do canal nas requisi√ß√µes para Asaas
ASAAS_ORIGIN_HEADERS_ENABLED=true

# Origem/dom√≠nio do canal (header Origin)
ASAAS_ORIGIN_HEADER=https://seudominio.com.br

# Token de acesso do canal fornecido pelo Asaas
ASAAS_CHANNEL_ACCESS_TOKEN=ch_seu_token_aqui

# Refer√™ncia externa padr√£o (fallback quando n√£o conseguir detectar tenant)
ASAAS_DEFAULT_EXTERNAL_REFERENCE=default_ref
```

### 6. Atualiza√ß√£o da Documenta√ß√£o Principal

**Arquivo:** `docs/asaas_module.md`

Adicionada se√ß√£o sobre headers de canal na documenta√ß√£o principal do m√≥dulo Asaas.

### 7. Fluxo de Funcionamento

1. **Inicializa√ß√£o**: Sistema verifica se `ASAAS_ORIGIN_HEADERS_ENABLED=true`
2. **Detec√ß√£o do Tenant**: Obt√©m refer√™ncia do tenant atual via:
   - `session('loja_id')` ‚Üí formato `loja_{id}`
     - Host/dom√≠nio ‚Üí formato `tenant_{subdomain}` ou `host_{domain}`
       - Fallback ‚Üí valor de `ASAAS_DEFAULT_EXTERNAL_REFERENCE`
       3. **Gera√ß√£o de Headers**: Monta array com 3 headers customizados
       4. **Inje√ß√£o Autom√°tica**: Todos os m√©todos do SDK (`payments()->create()`, `pixQrCode()`, etc.) incluem os headers
       5. **Logging**: Erros s√£o logados mas n√£o quebram o fluxo de pagamento

       ### 8. Exemplo de Requisi√ß√£o Resultante

       Com configura√ß√£o:

       ```bash
       ASAAS_ORIGIN_HEADERS_ENABLED=true
       ASAAS_ORIGIN_HEADER=https://nortgraf.com.br
       ASAAS_CHANNEL_ACCESS_TOKEN=ch_nortgraf_123
       ```

       E sess√£o com `loja_id = 42`, uma requisi√ß√£o t√≠pica para criar pagamento incluiria:

       ```http
       POST /payments HTTP/1.1
       Host: www.asaas.com
       access_token: $aact_YWJjZGVmZ2hpams...
       Accept: application/json
       Content-Type: application/json
       User-Agent: Asaas-SDK-Laravel/1.0
       Origin: https://nortgraf.com.br
       Origin-Channel-Access-Token: ch_nortgraf_123
       Origin-Channel-External-Reference: loja_42
       
       {
         "customer": "cus_abc123",
           "billingType": "PIX",
             "value": 99.90,
               "description": "Pedido #1234"
               }
       ```

       ### 9. Verifica√ß√£o e Testes

       Para testar se est√° funcionando:
       1. **Verificar configura√ß√£o**:

       ```bash
       php artisan tinker
       >>> config('asaas.origin_headers')
       ```
       2. **Testar gera√ß√£o de headers**:

       ```bash
       php artisan tinker
       >>> $service = app(\App\Services\OriginChannelHeaders::class);
       >>> $service->shouldSendHeaders()
       >>> $service->forCurrentTenant()
       ```
       3. **Monitorar logs**:

       ```bash
       tail -f storage/logs/laravel.log | grep -E "OriginChannelHeaders|AsaasClient"
       ```

       ### 10. Considera√ß√µes de Seguran√ßa
       - **Token sens√≠vel**: `ASAAS_CHANNEL_ACCESS_TOKEN` deve ser tratado como credencial secreta
       - **Fallback seguro**: Sistema falha silenciosamente para n√£o quebrar pagamentos
       - **Logs limitados**: N√£o loga dados sens√≠veis, apenas erros de configura√ß√£o
       - **Valida√ß√£o**: Headers s√≥ s√£o enviados se todas as valida√ß√µes passarem

       ### 11. Manuten√ß√£o e Atualiza√ß√µes

       **`Importante para futuras atualiza√ß√µes do pacote leopaulo88/asaas-sdk-laravel:`**
       1. **Backup da modifica√ß√£o**: Salve o diff do `AsaasClient.php`
       2. **Monitor de atualiza√ß√µes**: Use `composer show leopaulo88/asaas-sdk-laravel`
       3. **Reaplica√ß√£o**: Ap√≥s atualizar o pacote, reaplicar a modifica√ß√£o no `getHeaders()`

       **Op√ß√µes recomendadas**:
       - Fork do reposit√≥rio: `git clone` + modifica√ß√£o + `composer.json` apontando para seu fork
       - Patches do Composer: Use `cweagans/composer-patches` para automatizar a aplica√ß√£o

       ---

       ## Melhorias Implementadas (Janeiro 2025)

       Esta se√ß√£o documenta as melhorias de seguran√ßa e robustez para multi-tenant implementadas ap√≥s an√°lise detalhada do sistema.

       ### 1. Prioriza√ß√£o Correta de Detec√ß√£o de Tenant

       **Problema Identificado**: A detec√ß√£o de tenant via `session('loja_id')` pode falhar em contextos CLI/queue, e o fallback para subdom√≠nio podia extrair dados incorretos de dom√≠nios customizados de clientes.

       **Solu√ß√£o Implementada**: Nova ordem de prioridade robusta no m√©todo `getCurrentTenantReference()`:

       ```php
       /**
        * Obt√©m refer√™ncia externa do tenant atual com prioriza√ß√£o robusta
         */
         protected function getCurrentTenantReference(): ?string
         {
             try {
                     // PRIORIDADE #1: Current Loja (funciona em web, CLI, jobs, queue)
                             if (app()->bound('current_loja')) {
                                         $currentLoja = app('current_loja');
                                                     if ($currentLoja) {
                                                                     $identifier = $currentLoja->id ?? $currentLoja->uuid ?? null;
                                                                                     if ($identifier) {
                                                                                                         return "loja_{$identifier}";
                                                                                                                         }
                                                                                                                                     }
                                                                                                                                             }
       
                                                                                                                                                     // PRIORIDADE #2: Sess√£o web (apenas para web requests)
                                                                                                                                                             if (function_exists('session') && app()->bound('session.store')) {
                                                                                                                                                                         $lojaId = session('loja_id');
                                                                                                                                                                                     if ($lojaId) {
                                                                                                                                                                                                     return "loja_{$lojaId}";
                                                                                                                                                                                                                 }
                                                                                                                                                                                                                         }
       
                                                                                                                                                                                                                                 // PRIORIDADE #3: Subdom√≠nio APENAS se for *.nortgraf.com.br (evita dom√≠nios customizados)
                                                                                                                                                                                                                                         if (app()->bound('request')) {
                                                                                                                                                                                                                                                     $host = app('request')->getHost();
                                                                                                                                                                                                                                                                 if ($host && str_ends_with($host, '.nortgraf.com.br')) {
                                                                                                                                                                                                                                                                                 $subdomain = explode('.', $host)[0];
                                                                                                                                                                                                                                                                                                 if ($subdomain && $subdomain !== 'www') {
                                                                                                                                                                                                                                                                                                                     return "tenant_{$subdomain}";
                                                                                                                                                                                                                                                                                                                                     }
                                                                                                                                                                                                                                                                                                                                                 }
                                                                                                                                                                                                                                                                                                                                                         }
       
                                                                                                                                                                                                                                                                                                                                                                 // PRIORIDADE #4: Fallback configurado
                                                                                                                                                                                                                                                                                                                                                                         return Config::get('asaas.origin_headers.default_external_reference');
       
                                                                                                                                                                                                                                                                                                                                                                             } catch (\Exception $e) {
                                                                                                                                                                                                                                                                                                                                                                                     \Log::warning('[OriginChannelHeaders] Erro ao obter refer√™ncia do tenant', [
                                                                                                                                                                                                                                                                                                                                                                                                 'error' => $e->getMessage(),
                                                                                                                                                                                                                                                                                                                                                                                                             'trace' => app()->environment('local') ? $e->getTraceAsString() : null
                                                                                                                                                                                                                                                                                                                                                                                                                     ]);
                                                                                                                                                                                                                                                                                                                                                                                                                             return Config::get('asaas.origin_headers.default_external_reference');
                                                                                                                                                                                                                                                                                                                                                                                                                                 }
                                                                                                                                                                                                                                                                                                                                                                                                                                 }
       ```

       **Benef√≠cios**:
       - ‚úÖ **current_loja** tem prioridade m√°xima (funciona em todos os contextos)
       - ‚úÖ Subdom√≠nio s√≥ √© extra√≠do de dom√≠nios `*.nortgraf.com.br` (evita problemas com dom√≠nios customizados)
       - ‚úÖ Fallback garantido para CLI, jobs sem contexto
       - ‚úÖ Logging melhorado com trace apenas em ambiente local

       ### 2. Atualiza√ß√£o de Vari√°veis de Ambiente com Nomenclatura Melhorada

       **Problema**: Nomes de vari√°veis amb√≠guos que podiam causar confus√£o.

       **Solu√ß√£o**: Nomenclatura mais clara e consistente:

       ```bash
       # ANTES (confuso)
       ASAAS_ORIGIN_HEADER=https://seudominio.com.br
       
       # DEPOIS (claro e espec√≠fico)
       ASAAS_ORIGIN_VALUE=nortgraf-platform
       
       # ANTES (gen√©rico)
       ASAAS_DEFAULT_EXTERNAL_REFERENCE=default_channel_ref
       
       # DEPOIS (espec√≠fico para prop√≥sito)
       ASAAS_DEFAULT_EXTERNAL_REFERENCE=system
       ```

       **Atualiza√ß√£o na Configura√ß√£o**:

       ```php
       'origin_headers' => [
           'enabled' => (bool) env('ASAAS_ORIGIN_HEADERS_ENABLED', false),
               'origin' => env('ASAAS_ORIGIN_VALUE'), // ‚¨ÖÔ∏è Renamed
                   'channel_access_token' => env('ASAAS_CHANNEL_ACCESS_TOKEN'),
                       'default_external_reference' => env('ASAAS_DEFAULT_EXTERNAL_REFERENCE', 'system'), // ‚¨ÖÔ∏è Default value
                       ],
       ```

       ### 3. Debug Logging Tempor√°rio para Valida√ß√£o

       **Objetivo**: Confirmar que headers est√£o sendo aplicados corretamente em produ√ß√£o.

       **Implementa√ß√£o**: Debug logging tempor√°rio no `AsaasClient.php`:

       ```php
       protected function getHeaders(): array
       {
           $headers = [
                   'access_token' => $this->config['api_key'],
                           'Accept' => 'application/json',
                                   'Content-Type' => 'application/json',
                                           'User-Agent' => 'Asaas-SDK-Laravel/1.0',
                                               ];
       
                                                   // Headers din√¢micos de canal
                                                       try {
                                                               if (app()->bound(\App\Services\OriginChannelHeaders::class)) {
                                                                           $channelHeadersService = app(\App\Services\OriginChannelHeaders::class);
                                                                                       if ($channelHeadersService->shouldSendHeaders()) {
                                                                                                       $dynamicHeaders = $channelHeadersService->forCurrentTenant();
                                                                                                                       $headers = array_merge($headers, $dynamicHeaders);
                                                                                                                                       
                                                                                                                                                       // üîç DEBUG TEMPOR√ÅRIO - Confirmar aplica√ß√£o de headers
                                                                                                                                                                       \Log::debug('[AsaasClient] Headers de canal aplicados', [
                                                                                                                                                                                           'enabled' => true,
                                                                                                                                                                                                               'headers_count' => count($dynamicHeaders),
                                                                                                                                                                                                                                   'origin' => $dynamicHeaders['Origin'] ?? null,
                                                                                                                                                                                                                                                       'has_channel_token' => isset($dynamicHeaders['Origin-Channel-Access-Token']),
                                                                                                                                                                                                                                                                           'external_reference' => $dynamicHeaders['Origin-Channel-External-Reference'] ?? null,
                                                                                                                                                                                                                                                                                           ]);
                                                                                                                                                                                                                                                                                                       } else {
                                                                                                                                                                                                                                                                                                                       \Log::debug('[AsaasClient] Headers de canal desabilitados', ['enabled' => false]);
                                                                                                                                                                                                                                                                                                                                   }
                                                                                                                                                                                                                                                                                                                                           }
                                                                                                                                                                                                                                                                                                                                               } catch (\Throwable $e) {
                                                                                                                                                                                                                                                                                                                                                       \Log::warning('[AsaasClient] Erro ao obter headers de canal', [
                                                                                                                                                                                                                                                                                                                                                                   'error' => $e->getMessage()
                                                                                                                                                                                                                                                                                                                                                                           ]);
                                                                                                                                                                                                                                                                                                                                                                               }
       
                                                                                                                                                                                                                                                                                                                                                                                   return $headers;
                                                                                                                                                                                                                                                                                                                                                                                   }
       ```

       **‚ö†Ô∏è Importante**: Este logging √© **tempor√°rio** e deve ser removido ap√≥s valida√ß√£o em produ√ß√£o.

       ### 4. Exemplo de Configura√ß√£o Atualizada

       **Arquivo**: `.env.asaas.example` (atualizado)

       ```bash
       # =============================================================================
       # ASAAS - HEADERS DE CANAL/PARCERIA
       # =============================================================================
       
       # Ativar/Desativar headers de canal
       ASAAS_ORIGIN_HEADERS_ENABLED=true
       
       # Identificador do canal (header Origin) - use string simples e est√°vel
       # Evite URLs completas para n√£o depender de dom√≠nio/ambiente
       ASAAS_ORIGIN_VALUE=nortgraf-platform
       
       # Token de acesso do canal fornecido pelo Asaas
       ASAAS_CHANNEL_ACCESS_TOKEN=seu_token_do_canal_asaas
       
       # Refer√™ncia externa padr√£o (fallback para CLI, jobs, quando n√£o h√° contexto de loja)
       ASAAS_DEFAULT_EXTERNAL_REFERENCE=system
       ```

       ### 5. Valida√ß√£o em Produ√ß√£o

       **Plano de Teste Direto**:
       1. **Configurar ambiente**:

       ```bash
       ASAAS_ORIGIN_HEADERS_ENABLED=true
       ASAAS_ORIGIN_VALUE=nortgraf-platform
       ASAAS_CHANNEL_ACCESS_TOKEN=ch_seu_token
       ASAAS_DEFAULT_EXTERNAL_REFERENCE=system
       ```
       2. **Criar pagamento PIX sandbox**:

       ```php
       // Em algum controller/test
       $payment = $asaasService->createPixPayment([
           'customer' => $customer->asaas_customer_id,
               'value' => 10.0,
                   'description' => 'Teste headers canal'
                   ]);
       ```
       3. **Verificar logs**:

       ```bash
       tail -f storage/logs/laravel.log | grep "\[AsaasClient\]"
       ```

       **Expected Output**:

       ```
       [2025-01-21 15:30:42] local.DEBUG: [AsaasClient] Headers de canal aplicados {
           "enabled": true,
               "headers_count": 3,
                   "origin": "nortgraf-platform",
                       "has_channel_token": true,
                           "external_reference": "loja_42"
                           }
       ```

       ### 6. Benef√≠cios das Melhorias

       **Robustez Multi-tenant**:
       - ‚úÖ Funciona consistentemente em web, CLI, queue, jobs
       - ‚úÖ Nunca "chuta" subdom√≠nio de dom√≠nios customizados do cliente
       - ‚úÖ Sempre tem fallback funcional

       **Seguran√ßa**:
       - ‚úÖ Logging limitado, n√£o exp√µe tokens
       - ‚úÖ Graceful degradation se servi√ßo falhar
       - ‚úÖ Valida√ß√µes de contexto antes de extract

       **Manutenibilidade**:
       - ‚úÖ Nomes de vari√°veis mais claros
       - ‚úÖ Debug tempor√°rio para valida√ß√£o
       - ‚úÖ Documenta√ß√£o completa atualizada

       **Compatibilidade**:
       - ‚úÖ Backwards-compatible com configura√ß√µes existentes
       - ‚úÖ Zero breaking changes no comportamento
       - ‚úÖ Funciona com todos os m√©todos existentes do Asaas

       ### 7. Pr√≥ximos Passos
       1. **‚úÖ Implementa√ß√£o completa** - Todas as melhorias aplicadas
       2. **üü° Valida√ß√£o produ√ß√£o** - Criar PIX sandbox e confirmar logs
       3. **üü° Remover debug logs** - Ap√≥s confirma√ß√£o que funciona
       4. **üü° Documentar fork/patch** - Para manuten√ß√£o do vendor modification

       O sistema est√° agora robusto e pronto para uso em produ√ß√£o multi-tenant com todas as considera√ß√µes de seguran√ßa implementadas.